# @title ğŸš€ KHá»I Táº O WEBSITE CLONE GIá»ŒNG NÃ“I AI (PHIÃŠN Báº¢N á»”N Äá»ŠNH V3)
# Báº¥m nÃºt Play vÃ  Ä‘á»£i khoáº£ng 3-5 phÃºt Ä‘á»ƒ há»‡ thá»‘ng cÃ i Ä‘áº·t.

import os
import torch
from IPython.display import clear_output
import locale

# --- Cáº¤U HÃŒNH Há»† THá»NG ---
print("â³ Äang cÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t (FFmpeg, Coqui TTS, Gradio)...")
# Fix lá»—i encoding trÃªn Colab
locale.getpreferredencoding = lambda: "UTF-8"

# Tá»± Ä‘á»™ng Ä‘á»“ng Ã½ Ä‘iá»u khoáº£n
os.environ["COQUI_TOS_AGREED"] = "1"

# CÃ i Ä‘áº·t FFmpeg Ä‘á»ƒ xá»­ lÃ½ Ã¢m thanh máº¡nh máº½
!apt-get install -y ffmpeg > /dev/null

# CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n Python (Sá»­ dá»¥ng phiÃªn báº£n á»•n Ä‘á»‹nh nháº¥t)
!pip install -q coqui-tts==0.22.0 gradio==4.19.2 pydub typing-extensions>=4.8.0 nltk

clear_output()
print("âœ… CÃ i Ä‘áº·t thÆ° viá»‡n hoÃ n táº¥t! Äang táº£i mÃ´ hÃ¬nh AI...")

# --- Táº¢I MÃ” HÃŒNH AI ---
from TTS.api import TTS
from pydub import AudioSegment
import gradio as gr
import nltk
nltk.download('punkt') # Cáº§n cho viá»‡c tÃ¡ch cÃ¢u

# Kiá»ƒm tra GPU
device = "cuda" if torch.cuda.is_available() else "cpu"
if device == "cpu":
    print("\nâš ï¸ Cáº¢NH BÃO NGHIÃŠM TRá»ŒNG: Báº N CHÆ¯A Báº¬T GPU T4.")
    print("Vui lÃ²ng vÃ o 'Thá»i gian cháº¡y' -> 'Äá»•i loáº¡i' -> Chá»n 'T4 GPU'. Náº¿u khÃ´ng sáº½ ráº¥t cháº­m hoáº·c lá»—i.\n")

# Táº£i model XTTS v2 (Há»— trá»£ tiáº¿ng Viá»‡t tá»‘t nháº¥t hiá»‡n nay)
print("â³ Äang táº£i model XTTS v2 vá» GPU (Láº§n Ä‘áº§u máº¥t khoáº£ng 1 phÃºt)...")
tts = TTS("tts_models/multilingual/multi-dataset/xtts_v2").to(device)
print("âœ… ÄÃ£ táº£i xong mÃ´ hÃ¬nh! Sáºµn sÃ ng hoáº¡t Ä‘á»™ng.")

# --- CÃC HÃ€M Xá»¬ LÃ Cá»T LÃ•I (CHá»NG Lá»–I) ---

def sanitize_audio(audio_path):
    """
    HÃ m nÃ y lÃ  'Bá»™ lá»c': Tá»± Ä‘á»™ng chuyá»ƒn má»i file Ã¢m thanh Ä‘áº§u vÃ o 
    vá» chuáº©n WAV Mono 22050Hz Ä‘á»ƒ AI khÃ´ng bao giá» bá»‹ lá»—i.
    """
    try:
        print(f"ğŸ”„ Äang chuáº©n hÃ³a file Ã¢m thanh: {os.path.basename(audio_path)}")
        sound = AudioSegment.from_file(audio_path)
        # Chuyá»ƒn vá» 1 kÃªnh (mono) vÃ  táº§n sá»‘ 22050Hz
        sound = sound.set_channels(1).set_frame_rate(22050)
        cleaned_path = "temp_reference_cleaned.wav"
        sound.export(cleaned_path, format="wav")
        return cleaned_path
    except Exception as e:
        raise Exception(f"Lá»—i khi xá»­ lÃ½ file giá»ng máº«u. HÃ£y Ä‘áº£m báº£o file khÃ´ng bá»‹ há»ng. Chi tiáº¿t: {e}")

def split_text_smart(text):
    """Cáº¯t vÄƒn báº£n dÃ i thÃ nh cÃ¡c cÃ¢u ngáº¯n Ä‘á»ƒ trÃ¡nh trÃ n bá»™ nhá»›"""
    sentences = nltk.sent_tokenize(text)
    chunks = []
    current_chunk = ""
    for sentence in sentences:
        if len(current_chunk) + len(sentence) < 250: # Giá»›i háº¡n khoáº£ng 250 kÃ½ tá»± má»—i láº§n Ä‘á»c
            current_chunk += sentence + " "
        else:
            chunks.append(current_chunk.strip())
            current_chunk = sentence + " "
    if current_chunk:
        chunks.append(current_chunk.strip())
    return chunks

def generate_voice_safe(text, audio_ref, speed):
    """HÃ m táº¡o giá»ng chÃ­nh vá»›i cÆ¡ cháº¿ báº¯t lá»—i vÃ  xá»­ lÃ½ vÄƒn báº£n dÃ i"""
    if not text or text.strip() == "":
        return None, "âŒ Lá»—i: Vui lÃ²ng nháº­p vÄƒn báº£n cáº§n Ä‘á»c!"
    if not audio_ref:
        return None, "âŒ Lá»—i: Vui lÃ²ng táº£i lÃªn file giá»ng máº«u!"

    status_log = "ğŸš€ Báº¯t Ä‘áº§u tiáº¿n trÃ¬nh...\n"
    final_output_path = "final_output.wav"
    combined_audio = AudioSegment.empty()
    temp_files = []

    try:
        # BÆ¯á»šC 1: Chuáº©n hÃ³a file giá»ng máº«u
        clean_ref = sanitize_audio(audio_ref)
        status_log += "âœ… ÄÃ£ chuáº©n hÃ³a file giá»ng máº«u thÃ nh cÃ´ng.\n"

        # BÆ¯á»šC 2: Cáº¯t vÄƒn báº£n dÃ i
        chunks = split_text_smart(text)
        status_log +=(f"â„¹ï¸ VÄƒn báº£n Ä‘Æ°á»£c chia thÃ nh {len(chunks)} Ä‘oáº¡n nhá» Ä‘á»ƒ xá»­ lÃ½ an toÃ n.\n")

        # BÆ¯á»šC 3: Äá»c tá»«ng Ä‘oáº¡n
        for i, chunk in enumerate(chunks):
            print(f"Processing chunk {i+1}/{len(chunks)}...")
            temp_path = f"temp_chunk_{i}.wav"
            
            # Gá»i AI Ä‘á»ƒ Ä‘á»c (QUAN TRá»ŒNG: split_sentences=False vÃ¬ ta Ä‘Ã£ tá»± cáº¯t rá»“i)
            tts.tts_to_file(
                text=chunk,
                file_path=temp_path,
                speaker_wav=clean_ref,
                language="vi", 
                split_sentences=False,
                speed=speed
            )
            
            # GhÃ©p Ä‘oáº¡n vá»«a Ä‘á»c vÃ o file tá»•ng
            segment = AudioSegment.from_wav(temp_path)
            combined_audio += segment
            # ThÃªm khoáº£ng nghá»‰ ngáº¯n (300ms) giá»¯a cÃ¡c cÃ¢u cho tá»± nhiÃªn
            combined_audio += AudioSegment.silent(duration=300)
            temp_files.append(temp_path)
            
            # Giáº£i phÃ³ng bá»™ nhá»› GPU sau má»—i Ä‘oáº¡n
            torch.cuda.empty_cache()

        # BÆ¯á»šC 4: Xuáº¥t file cuá»‘i cÃ¹ng
        combined_audio.export(final_output_path, format="wav")
        status_log += "âœ… HoÃ n táº¥t! File Ã¢m thanh Ä‘Ã£ sáºµn sÃ ng bÃªn dÆ°á»›i."
        
        # Dá»n dáº¹p file rÃ¡c
        for f in temp_files: 
            if os.path.exists(f): os.remove(f)
            
        return final_output_path, status_log

    except Exception as e:
        error_message = str(e)
        if "CUDA out of memory" in error_message:
            return None, "âŒ Lá»–I TRÃ€N Bá»˜ NHá»š GPU. HÃ£y thá»­ láº¡i vá»›i vÄƒn báº£n ngáº¯n hÆ¡n má»™t chÃºt."
        return None, f"âŒ ÄÃƒ Xáº¢Y RA Lá»–I Ká»¸ THUáº¬T:\n{error_message}\n(HÃ£y thá»­ Ä‘á»•i file giá»ng máº«u khÃ¡c ngáº¯n hÆ¡n)"


# --- GIAO DIá»†N NGÆ¯á»œI DÃ™NG (GRADIO) ---
# Táº¡o giao diá»‡n giá»‘ng trang web máº«u
custom_css = """
.gradio-container {font-family: 'Roboto', sans-serif;}
#run-btn {background-color: #2563eb !important; color: white !important; font-weight: bold; font-size: 16px;}
"""

with gr.Blocks(title="Dá»± Ãn Táº¡o Giá»ng NÃ³i AI", theme=gr.themes.Soft(), css=custom_css) as demo:
    gr.Markdown("# ğŸ™ï¸ Dá»° ÃN Ã‚M THANH AI (CLONE GIá»ŒNG NÃ“I)")
    gr.Markdown("CÃ´ng cá»¥ chuyá»ƒn vÄƒn báº£n thÃ nh giá»ng nÃ³i tiáº¿ng Viá»‡t, sá»­ dá»¥ng giá»ng máº«u báº¥t ká»³.")
    
    with gr.Row():
        # Cá»™t bÃªn trÃ¡i: Cáº¥u hÃ¬nh
        with gr.Column(scale=1):
            gr.Markdown("### 1. Cáº¥u hÃ¬nh Giá»ng nÃ³i")
            inp_audio = gr.Audio(
                label="Táº£i lÃªn file giá»ng máº«u (MP3/WAV)", 
                type="filepath",
                sources=["upload", "microphone"]
            )
            gr.Markdown("â„¹ï¸ *Máº¹o: Chá»n file rÃµ tiáº¿ng, khÃ´ng nháº¡c ná»n, khoáº£ng 10-30 giÃ¢y lÃ  tá»‘t nháº¥t.*")
            
            inp_speed = gr.Slider(
                label="Tá»‘c Ä‘á»™ Ä‘á»c", 
                minimum=0.75, maximum=1.5, value=1.0, step=0.05,
                info="1.0 lÃ  bÃ¬nh thÆ°á»ng. < 1 lÃ  cháº­m, > 1 lÃ  nhanh."
            )

        # Cá»™t á»Ÿ giá»¯a: VÄƒn báº£n
        with gr.Column(scale=2):
            gr.Markdown("### 2. Ná»™i dung VÄƒn báº£n")
            inp_text = gr.Textbox(
                label="Nháº­p vÄƒn báº£n Tiáº¿ng Viá»‡t táº¡i Ä‘Ã¢y", 
                lines=12, 
                placeholder="VÃ­ dá»¥: Xin chÃ o, Ä‘Ã¢y lÃ  giá»ng nÃ³i AI Ä‘Æ°á»£c táº¡o ra tá»« giá»ng máº«u cá»§a báº¡n. CÃ´ng nghá»‡ nÃ y cho phÃ©p Ä‘á»c cÃ¡c Ä‘oáº¡n vÄƒn báº£n dÃ i má»™t cÃ¡ch tá»± nhiÃªn...",
                elem_id="input-text"
            )
            btn_run = gr.Button("ğŸš€ Táº O Ã‚M THANH NGAY", elem_id="run-btn")

        # Cá»™t bÃªn pháº£i: Káº¿t quáº£
        with gr.Column(scale=1):
             gr.Markdown("### 3. Káº¿t quáº£")
             out_status = gr.Textbox(label="Nháº­t kÃ½ xá»­ lÃ½", lines=6, interactive=False)
             out_audio = gr.Audio(label="Nghe vÃ  Táº£i vá»", type="filepath", interactive=False)

    # Káº¿t ná»‘i sá»± kiá»‡n báº¥m nÃºt
    btn_run.click(
        fn=generate_voice_safe, 
        inputs=[inp_text, inp_audio, inp_speed], 
        outputs=[out_audio, out_status]
    )

# Cháº¡y server
print("\n" + "="*50)
print("ğŸŒ ÄANG KHá»I Táº O WEB SERVER...")
print("Vui lÃ²ng Ä‘á»£i khoáº£ng 1-2 phÃºt cho Ä‘áº¿n khi Ä‘Æ°á»ng link hiá»‡n ra.")
print("="*50)
# Sá»­ dá»¥ng queue Ä‘á»ƒ xá»­ lÃ½ cÃ¡c yÃªu cáº§u dÃ i mÃ  khÃ´ng bá»‹ timeout
demo.queue(max_size=5).launch(share=True, debug=True, show_error=True)
